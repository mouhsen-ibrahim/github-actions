name: Reusable service workflow

on:
  workflow_call:
    inputs:
      service:
        type: string
        required: true
      artifact_load:
        type: string
        required: true
        default: ''
      artifact_tar:
        type: boolean
        required: false
        default: false
      git_branch:
        type: string
        required: true
      target:
        type: string
        required: true
      run_tests:
        type: boolean
        required: false
        default: true
      env:
        type: string
        required: true
    secrets:
      AZURE_CLIENT_ID:
        required: false
      AZURE_TENANT_ID:
        required: false
      AZURE_SUBSCRIPTION_ID:
        required: false
      GCP_PROJECT_ID:
        required: false
      GCP_WORKLOAD_IDENTITY_PROVIDER:
        required: false
      GCP_SERVICE_ACCOUNT:
        required: false
      GCP_BUCKET_NAME:
        required: false

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write

jobs:
  build:
    name: ${{ inputs.target }}-${{ fromJson(inputs.service).name }}-${{ inputs.env }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: get docker registry
        id: get_docker_registry
        run: |
          echo "Getting docker registry"
          echo "DOCKER_REGISTRY=$(cat Makefile.variables | grep -oP 'DOCKER_REGISTRY=\K[^ ]+')" >> $GITHUB_OUTPUT

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.get_docker_registry.outputs.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Azure Login with OIDC
        if: ${{ fromJson(inputs.service).authentication.azure == 'enabled' }}
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Login to GCP
        uses: google-github-actions/auth@v3
        if: ${{ fromJson(inputs.service).authentication.gcp == 'enabled' || fromJson(inputs.service).load != '' || fromJson(inputs.service).save != '' }}
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true
          token_format: access_token
      - name: Save data to GCS
        if: ${{ fromJson(inputs.service).save != '' }}
        run: |
          echo "Saving data to GCS: ${{ fromJson(inputs.service).name }}"
          echo '${{ toJson(fromJson(inputs.service).save) }}' > state.json
          gcloud storage cp state.json gs://${{ secrets.GCP_BUCKET_NAME }}/${{ inputs.env }}/${{ fromJson(inputs.service).name }}/${{ inputs.git_branch }}.json
      - name: load state
        id: state
        if: ${{ fromJson(inputs.service).load != '' }}
        shell: bash
        run: |
          path="gs://${{ secrets.GCP_BUCKET_NAME }}/${{ inputs.env }}/${{ fromJson(inputs.service).load }}/${{ inputs.git_branch }}.json"
          fallback="gs://${{ secrets.GCP_BUCKET_NAME }}/${{ fromJson(inputs.service).load }}/main.json"
          if gcloud storage ls "$path"; then
            JSON=$(gcloud storage cat "$path")
            echo "Using branch state: $path"
          elif gcloud storage ls "$fallback"; then
            JSON=$(gcloud storage cat "$fallback")
            echo "Branch state missing; using fallback: $fallback"
          else
            echo "No state found for branch or main."
            exit 0
          fi
          jq -c '.[]' <<<"$JSON" | while IFS= read -r obj; do
            envKey=$(jq -r '.envKey // .key // empty' <<<"$obj")
            val=$(jq -r '.value // empty' <<<"$obj")
            if [[ -n "$envKey" && -n "$val" ]]; then
              echo "$envKey=$val" >> "$GITHUB_ENV"
            fi
          done
      - uses: actions/download-artifact@v5
        if: ${{ inputs.artifact_load != '' }}
        with:
          name: ${{ inputs.artifact_load }}-${{ inputs.env }}
          path: "${{ fromJson(inputs.service).artifact_path }}"
      - name: untar artifact
        if: ${{ inputs.artifact_tar && inputs.artifact_load != '' }}
        run: mkdir -p ${{ fromJson(inputs.service).artifact_path }} && tar --no-same-owner -xzf ${{ inputs.artifact_load }}.tar -C ${{ fromJson(inputs.service).artifact_path }}
      - name: ${{ inputs.target }} service
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          [ -f "${HOME}/.config/gcloud/application_default_credentials.json" ] || mkdir -p ${HOME}/.config/gcloud && touch "${HOME}/.config/gcloud/application_default_credentials.json"
          echo "${{ inputs.target }}ing service: ${{ fromJson(inputs.service).name }}"
          echo "Service path: ${{ fromJson(inputs.service).path }}"
          cd "${{ fromJson(inputs.service).path }}"
          if [ -f "Makefile" ]; then
            ENV=${{ inputs.env }} make ${{ inputs.target }}
          else
            echo "No Makefile found in ${{ fromJson(inputs.service).path }}"
          fi
      - name: Create tarball for artifacts
        if: ${{ inputs.artifact_tar && inputs.target == 'build' }}
        run: tar -czf ${{ fromJson(inputs.service).artifact }}.tar -C ${{ fromJson(inputs.service).artifact_path }} .
      - name: Save service artifacts
        if: ${{ fromJson(inputs.service).artifact != '' && inputs.target == 'build' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ fromJson(inputs.service).artifact }}-${{ inputs.env }}
          path: ${{ fromJson(inputs.service).artifact_path }}

      - name: Test service
        if: ${{ inputs.run_tests }}
        run: |
          echo "Testing service: ${{ fromJson(inputs.service).name }}"
          cd "${{ fromJson(inputs.service).path }}"
          if [ -f "Makefile" ]; then
            ENV=${{ inputs.env }} make test
          else
            echo "No Makefile found for testing in ${{ fromJson(inputs.service).path }}"
          fi